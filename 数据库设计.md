# 【1】建库

```sql
CREATE DATABASE IF NOT EXISTS nova_chat
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_general_ci;
USE nova_chat;
```

------

# 【2】用户表（user）

```sql
CREATE TABLE user (
    id           BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    username     VARCHAR(50) UNIQUE NOT NULL COMMENT '账号',
    password     VARCHAR(200) NOT NULL COMMENT '密码',
    nickname     VARCHAR(50) NOT NULL COMMENT '昵称',
    avatar_url   VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
    signature    VARCHAR(255) DEFAULT NULL COMMENT '个性签名',
    created_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

------

# 【3】好友关系表（friend）

```sql
CREATE TABLE friend (
    id          BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id     BIGINT NOT NULL COMMENT '自己',
    friend_id   BIGINT NOT NULL COMMENT '好友',
    status      TINYINT DEFAULT 1 COMMENT '1正常，0拉黑',
    created_at  DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user (user_id),
    INDEX idx_friend (friend_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='好友关系表';
```

------

# 【4】好友申请表（friend_request）

```
CREATE TABLE friend_request (
    id             BIGINT PRIMARY KEY AUTO_INCREMENT,
    from_user_id   BIGINT NOT NULL COMMENT '申请发起人',
    to_user_id     BIGINT NOT NULL COMMENT '申请接收人',
    status         TINYINT DEFAULT 0 COMMENT '0待处理 1同意 2拒绝',
    created_at     DATETIME DEFAULT CURRENT_TIMESTAMP,
    handled_at     DATETIME DEFAULT NULL,

    INDEX idx_from (from_user_id),
    INDEX idx_to (to_user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='好友申请表';
```

------

# 【5】会话表（conversation）

```sql
CREATE TABLE conversation (
    id             BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '会话ID',
    user_id        BIGINT NOT NULL COMMENT '属于哪个用户的会话',
    target_id      BIGINT NOT NULL COMMENT '聊天对象ID（用户ID或群ID）',
    target_type    TINYINT NOT NULL COMMENT '1单聊 2群聊',
    last_message   VARCHAR(255) DEFAULT NULL COMMENT '会话摘要',
    last_time      DATETIME DEFAULT NULL COMMENT '最后一条消息时间',
    unread_count   INT DEFAULT 0 COMMENT '未读数量',
    is_top         TINYINT DEFAULT 0 COMMENT '是否置顶',
    is_mute        TINYINT DEFAULT 0 COMMENT '是否免打扰',
    updated_at     DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_user (user_id),
    INDEX idx_target (target_id, target_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会话表';
```

------

# 【6】消息表（message）

➡ **核心设计：单聊和群聊共用同一张表**
 ➡ 群聊用 group_id，单聊用 receiver_id

```sql
CREATE TABLE message (
    id               BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '消息ID',
    conversation_id  BIGINT NOT NULL COMMENT '所属会话ID',
    sender_id        BIGINT NOT NULL COMMENT '发送者ID',

    receiver_id      BIGINT DEFAULT NULL COMMENT '单聊接收者ID（群聊为空）',
    group_id         BIGINT DEFAULT NULL COMMENT '群聊ID（单聊为空）',

    msg_type         TINYINT NOT NULL DEFAULT 1 COMMENT '消息类型：1文本 2图片 3文件 4语音',
    content          TEXT COMMENT '消息内容或JSON',
    file_id          BIGINT DEFAULT NULL COMMENT '关联文件ID',

    status           TINYINT DEFAULT 0 COMMENT '状态 0发送中 1已送达 2已读',
    created_at       DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_conversation (conversation_id),
    INDEX idx_receiver (receiver_id),
    INDEX idx_group (group_id),
    INDEX idx_sender (sender_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='聊天消息表';
```

> 解释：
>
> - 单聊：sender_id + receiver_id
> - 群聊：sender_id + group_id
> - 会话更新依赖 conversation_id
> - status 字段支持已读/未读

------

# 【7】群聊表（group_info）

```sql
CREATE TABLE group_info (
    id           BIGINT PRIMARY KEY AUTO_INCREMENT,
    name         VARCHAR(100) NOT NULL,
    avatar_url   VARCHAR(255) DEFAULT NULL,
    owner_id     BIGINT NOT NULL COMMENT '群主用户ID',
    created_at   DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at   DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_owner (owner_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群聊表';
```

------

# 【8】群成员表（group_member）

```sql
CREATE TABLE group_member (
    id          BIGINT PRIMARY KEY AUTO_INCREMENT,
    group_id    BIGINT NOT NULL COMMENT '群ID',
    user_id     BIGINT NOT NULL COMMENT '用户ID',
    role        TINYINT DEFAULT 3 COMMENT '1群主 2管理员 3成员',
    join_time   DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_group (group_id),
    INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群成员表';
```

------

# 【9】文件表（file_info）

```sql
CREATE TABLE file_info (
    id           BIGINT PRIMARY KEY AUTO_INCREMENT,
    uploader_id  BIGINT NOT NULL COMMENT '上传者ID',
    file_url     VARCHAR(500) NOT NULL,
    file_type    VARCHAR(20) NOT NULL COMMENT 'image/file/voice',
    size         BIGINT DEFAULT 0 COMMENT '大小字节',
    created_at   DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_uploader (uploader_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件信息表';
```





# SQL 2.0

```sql
CREATE DATABASE IF NOT EXISTS novachat CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci;
USE novachat;

-- ===================================
-- 1. 用户表
-- ===================================
CREATE TABLE `nova_chat_user` (
    `id`            BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    `user_id`       CHAR(60) NOT NULL COMMENT '用户ID',
    `user_name`      VARCHAR(50) UNIQUE NOT NULL COMMENT '登录账号',
    `password`      VARCHAR(100) NOT NULL COMMENT '密码',
    `nick_name`      VARCHAR(50) NOT NULL DEFAULT '' COMMENT '昵称',
    `avatar`        VARCHAR(600) NULL COMMENT '用户头像URL',
    `mobile`        VARCHAR(20) UNIQUE NULL COMMENT '手机号',
    `signature`     VARCHAR(500) DEFAULT '暂无签名' COMMENT '签名',
    `status`        INT NOT NULL DEFAULT 1 COMMENT '用户状态 1正常 2禁用',
    `role_code`     INT NOT NULL DEFAULT 1 COMMENT '角色 1普通用户 等等',
    `create_by`     CHAR(60) DEFAULT NULL COMMENT '创建人',
    `create_date`   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_by`     CHAR(60) DEFAULT NULL COMMENT '更新人',
    `update_date`   DATETIME DEFAULT NULL COMMENT '更新时间',
    `version`       INT DEFAULT '0' COMMENT '版本',
    KEY `index_user_id` (`user_id`),
    INDEX `idx_mobile` (`mobile`),
    INDEX `idx_status` (`status`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- ===================================
-- 2. 文件表
-- ===================================
CREATE TABLE `nova_chat_file_info` (
    `id`            BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    `uploader_id`   CHAR(60) NOT NULL COMMENT '上传者用户ID',
    `object_key`    VARCHAR(500) NOT NULL COMMENT 'MinIO完整objectKey，如 image/2025/12/02/abc123.jpg',
    `file_url`      VARCHAR(600) NOT NULL COMMENT '完整可访问URL（你代码拼接的那种）',
    `file_name`     VARCHAR(255) NOT NULL COMMENT '原始文件名，如 头像.jpg',
    `size`          BIGINT DEFAULT 0 COMMENT '文件大小字节',
    `upload_date`   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
    `version`       INT DEFAULT '0' COMMENT '版本',
    UNIQUE KEY `uniq_object_key` (`object_key`),
    INDEX `idx_uploader` (`uploader_id`),
    INDEX `idx_upload_date` (`upload_date` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件信息表（当前阶段最优设计）';

-- ===================================
-- 3. 会话表（核心）
-- ===================================
CREATE TABLE `nova_chat_conversation` (
    `id`             BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    `user_id`        CHAR(60) NOT NULL COMMENT '属于谁的会话',
    `target_id`      CHAR(60) NOT NULL COMMENT '对方用户ID 或 群ID',
    `target_type`    TINYINT NOT NULL COMMENT '1单聊 2群聊',
    `last_msg_id`    BIGINT UNSIGNED NULL COMMENT '最后一条消息ID', -- last_msg_id = message.id
    `last_message`   VARCHAR(300) NULL COMMENT '会话摘要',
    `last_time`      DATETIME NULL,
    `unread_count`   INT DEFAULT 0,
    `is_top`         TINYINT DEFAULT 0 COMMENT '是否置顶 0不置顶 1置顶',
    `create_by`      CHAR(60) DEFAULT NULL COMMENT '创建人',
    `create_date`    DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_by`      CHAR(60) DEFAULT NULL COMMENT '更新人',
    `update_date`    DATETIME DEFAULT NULL COMMENT '更新时间',
    `version`        INT DEFAULT '0' COMMENT '版本',
  	INDEX `index_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会话表';

-- ===================================
-- 4. 消息表（单聊群聊共用）
-- ===================================
CREATE TABLE `nova_chat_message` (
    `id`              BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    `conversation_id` BIGINT UNSIGNED NOT NULL COMMENT '所属会话', -- conversation_id = conversation.id
    `sender_id`       CHAR(60) NOT NULL,
    `receiver_id`     CHAR(60) NULL COMMENT '接收人id',
    `receiver_type`   TINYINT NULL COMMENT '接收人类型 1单聊 2群聊 等',
    `message_type`    TINYINT NOT NULL DEFAULT 1 COMMENT '1文本 2图片 3语音 4视频 5文件 等',
    `content`         VARCHAR(1000) NULL COMMENT '消息内容',
    `is_revoke`       TINYINT DEFAULT 0 COMMENT '是否撤回 0不撤回',
    `send_date`     	DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '发送时间',
    `update_date`     DATETIME DEFAULT NULL COMMENT '更新时间',
    `version`         INT DEFAULT '0' COMMENT '版本',
    INDEX `idx_conv_time` (`conversation_id`, `send_date` DESC),
    INDEX `idx_sender` (`sender_id`),
    INDEX `idx_group` (`receiver_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息表';

-- ===================================
-- 5. 好友关系表
-- ===================================
CREATE TABLE `nova_chat_friend` (
    `id`         BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    `user_id`    CHAR(60) NOT NULL,
    `friend_id`  CHAR(60) NOT NULL,
    `remark`     VARCHAR(50) DEFAULT NULL COMMENT '备注名',
    `status`     TINYINT DEFAULT 1 COMMENT '1正常 0拉黑',
		`type`			 TINYINT DEFAULT 1 COMMENT '1好友关注 2订阅公众号 等',
		`apply_date` DATETIME DEFAULT NULL COMMENT '申请时间',
		`handle_date` DATETIME DEFAULT NULL COMMENT '处理时间',
    `version`    INT DEFAULT '0' COMMENT '版本',
  	INDEX `idx_user_id` (`user_id`),
    INDEX `idx_friend` (`friend_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='好友关系表';

-- ===================================
-- 6. 好友申请表（可选，但建议有）
-- ===================================
CREATE TABLE `nova_chat_friend_apply` (
    `id`           BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    `from_user_id` CHAR(60) NOT NULL,
    `to_user_id`   CHAR(60) NOT NULL,
    `remark`       VARCHAR(200) DEFAULT '' COMMENT '申请备注',
    `status`       TINYINT DEFAULT 0 COMMENT '0待处理 1同意 2拒绝',
    `create_date`  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_date`  DATETIME DEFAULT NULL COMMENT '更新时间',
    `version`      INT DEFAULT '0' COMMENT '版本',
    INDEX `idx_from` (`from_user_id`),
    INDEX `idx_to` (`to_user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='好友申请表';

-- ===================================
-- 7. 群聊表 + 群成员表（极简群聊）
-- ===================================
CREATE TABLE `nova_chat_group` (
    `id`           BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    `group_id`     CHAR(60) NOT NULL,
    `group_name`         CHAR(60) NOT NULL,
    `avatar`       VARCHAR(600) NULL,
    `create_by`    CHAR(60) DEFAULT NULL COMMENT '创建人',
    `create_date`  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `version`      INT DEFAULT '0' COMMENT '版本',
  	INDEX `idx_group_id` (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群聊表';

CREATE TABLE `nova_chat_group_member` (
 	 	`id`        BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    `group_id`  BIGINT UNSIGNED NOT NULL,  -- group_id = group.group_id
    `user_id`   CHAR(60) NOT NULL,
    `role`      TINYINT DEFAULT 3 COMMENT '1群主 2管理员 3成员',
    `join_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
 		`version`   INT DEFAULT '0' COMMENT '版本',
    INDEX `idx_user` (`user_id`),
  	INDEX `idx_group_id` (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群成员表';
```

